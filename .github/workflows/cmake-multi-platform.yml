# .github/workflows/cmake-multi-platform.yml

name: CMake Multi-Platform Build

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        platform: [x86_64, armhf, arm64]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU for multiarch
        uses: docker/setup-qemu-action@v2
        with:
          platforms: arm/arm64,arm/v7

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build and run in Docker
        run: |
          if [ "${{ matrix.platform }}" == "x86_64" ]; then
            IMAGE=ubuntu:22.04
          elif [ "${{ matrix.platform }}" == "arm64" ]; then
            IMAGE=arm64v8/ubuntu:22.04
          else
            IMAGE=arm32v7/ubuntu:22.04
          fi

          docker run --rm -v $PWD:/workspace -w /workspace $IMAGE bash -c "
            apt-get update && apt-get install -y cmake build-essential git \
              libcurl4-openssl-dev libncurses-dev libarchive-dev zip \
              curl && \
            git clone --branch main https://github.com/ArthurSonzogni/FTXUI.git /tmp/ftxui && \
            mkdir -p /tmp/ftxui/build && cd /tmp/ftxui/build && \
            cmake -DCMAKE_BUILD_TYPE=Release -DFTXUI_BUILD_SHARED=ON .. && \
            cmake --build . --config Release && \
            cmake --install . && \
            mkdir -p build/${{ matrix.platform }} && cd build/${{ matrix.platform }} && \
            cmake -DCMAKE_BUILD_TYPE=Release -S ../../ -B . && cmake --build . --config Release && \
            chmod +x Chrootux && zip -j Chrootux-${{ matrix.platform }}.zip Chrootux
          "

      - name: Upload binary as artifact
        uses: actions/upload-artifact@v4
        with:
          name: Chrootux-${{ matrix.platform }}
          path: build/${{ matrix.platform }}/Chrootux-${{ matrix.platform }}.zip
